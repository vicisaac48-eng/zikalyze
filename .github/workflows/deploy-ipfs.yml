name: Deploy to IPFS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  APP_NAME: zikalyze

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      ipfs_hash: ${{ steps.pinata.outputs.ipfs_hash }}
      ens_content_hash: ${{ steps.pinata.outputs.ens_content_hash }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Pin to IPFS via Pinata
        id: pinata
        env:
          PINATA_API_KEY: ${{ secrets.PINATA_API_KEY }}
          PINATA_SECRET_KEY: ${{ secrets.PINATA_SECRET_KEY }}
        run: |
          # Create upload script with ENS content hash output
          cat << 'EOF' > upload.mjs
          import axios from 'axios';
          import FormData from 'form-data';
          import fs from 'fs';
          import path from 'path';
          
          const PINATA_API_KEY = process.env.PINATA_API_KEY;
          const PINATA_SECRET_KEY = process.env.PINATA_SECRET_KEY;
          const APP_NAME = process.env.APP_NAME || 'zikalyze';
          
          async function getAllFiles(dirPath, arrayOfFiles = []) {
            const files = fs.readdirSync(dirPath);
            for (const file of files) {
              const filePath = path.join(dirPath, file);
              if (fs.statSync(filePath).isDirectory()) {
                await getAllFiles(filePath, arrayOfFiles);
              } else {
                arrayOfFiles.push(filePath);
              }
            }
            return arrayOfFiles;
          }
          
          // Convert CIDv1 to ENS content hash format
          function toEnsContentHash(cidV1) {
            return `ipfs://${cidV1}`;
          }
          
          async function uploadToPinata() {
            const distPath = './dist';
            const files = await getAllFiles(distPath);
            
            const formData = new FormData();
            
            for (const filePath of files) {
              const relativePath = path.relative(distPath, filePath);
              formData.append('file', fs.createReadStream(filePath), {
                filepath: `${APP_NAME}/${relativePath}`
              });
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            formData.append('pinataMetadata', JSON.stringify({
              name: `${APP_NAME}-${timestamp}`,
              keyvalues: {
                app: APP_NAME,
                version: timestamp,
                type: 'production'
              }
            }));
            
            formData.append('pinataOptions', JSON.stringify({
              cidVersion: 1,
              wrapWithDirectory: true
            }));
            
            const response = await axios.post(
              'https://api.pinata.cloud/pinning/pinFileToIPFS',
              formData,
              {
                maxBodyLength: Infinity,
                headers: {
                  ...formData.getHeaders(),
                  'pinata_api_key': PINATA_API_KEY,
                  'pinata_secret_api_key': PINATA_SECRET_KEY
                }
              }
            );
            
            const ipfsHash = response.data.IpfsHash;
            const ensContentHash = toEnsContentHash(ipfsHash);
            
            // Output for GitHub Actions
            const outputFile = process.env.GITHUB_OUTPUT;
            if (outputFile) {
              fs.appendFileSync(outputFile, `ipfs_hash=${ipfsHash}\n`);
              fs.appendFileSync(outputFile, `ens_content_hash=${ensContentHash}\n`);
            }
            
            console.log('='.repeat(60));
            console.log('ðŸš€ IPFS DEPLOYMENT SUCCESSFUL');
            console.log('='.repeat(60));
            console.log(`\nðŸ“¦ IPFS CID: ${ipfsHash}`);
            console.log(`\nðŸ”— ACCESS URLS:`);
            console.log(`   Pinata:  https://gateway.pinata.cloud/ipfs/${ipfsHash}/${APP_NAME}/`);
            console.log(`   IPFS.io: https://ipfs.io/ipfs/${ipfsHash}/${APP_NAME}/`);
            console.log(`   DWeb:    https://${ipfsHash}.ipfs.dweb.link/${APP_NAME}/`);
            console.log(`\nðŸ·ï¸  ENS CONTENT HASH:`);
            console.log(`   ${ensContentHash}`);
            console.log(`\nðŸ“ To link to ENS (e.g., zikalyze.eth):`);
            console.log(`   1. Go to https://app.ens.domains`);
            console.log(`   2. Select your ENS domain`);
            console.log(`   3. Click "Add/Edit Record" â†’ "Content Hash"`);
            console.log(`   4. Paste: ${ensContentHash}`);
            console.log('='.repeat(60));
            
            // Save deployment info
            const deploymentInfo = {
              timestamp: new Date().toISOString(),
              ipfsHash,
              ensContentHash,
              urls: {
                pinata: `https://gateway.pinata.cloud/ipfs/${ipfsHash}/${APP_NAME}/`,
                ipfs: `https://ipfs.io/ipfs/${ipfsHash}/${APP_NAME}/`,
                dweb: `https://${ipfsHash}.ipfs.dweb.link/${APP_NAME}/`
              }
            };
            
            fs.writeFileSync('ipfs-deployment.json', JSON.stringify(deploymentInfo, null, 2));
          }
          
          uploadToPinata().catch(err => {
            console.error('Deployment failed:', err.message);
            process.exit(1);
          });
          EOF
          
          node upload.mjs

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: ipfs-deployment
          path: ipfs-deployment.json

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Zikalyze IPFS Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ IPFS Details" >> $GITHUB_STEP_SUMMARY
          echo "- **CID:** \`${{ steps.pinata.outputs.ipfs_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ENS Content Hash:** \`${{ steps.pinata.outputs.ens_content_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- [Pinata Gateway](https://gateway.pinata.cloud/ipfs/${{ steps.pinata.outputs.ipfs_hash }}/zikalyze/)" >> $GITHUB_STEP_SUMMARY
          echo "- [IPFS.io](https://ipfs.io/ipfs/${{ steps.pinata.outputs.ipfs_hash }}/zikalyze/)" >> $GITHUB_STEP_SUMMARY
          echo "- [DWeb Link](https://${{ steps.pinata.outputs.ipfs_hash }}.ipfs.dweb.link/zikalyze/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ ENS Setup" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [ENS App](https://app.ens.domains)" >> $GITHUB_STEP_SUMMARY
          echo "2. Select your domain (e.g., zikalyze.eth)" >> $GITHUB_STEP_SUMMARY
          echo "3. Add Content Hash record with: \`${{ steps.pinata.outputs.ens_content_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access via ENS" >> $GITHUB_STEP_SUMMARY
          echo "Once configured, access via:" >> $GITHUB_STEP_SUMMARY
          echo "- \`zikalyze.eth.limo\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`zikalyze.eth.link\`" >> $GITHUB_STEP_SUMMARY
          echo "- Brave/Opera browsers: \`zikalyze.eth\`" >> $GITHUB_STEP_SUMMARY
